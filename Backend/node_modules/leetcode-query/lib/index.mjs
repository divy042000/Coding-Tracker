"use strict";import O from"events";import E from"node-fetch";var x=class{constructor(){this._table={}}get(i){let e=this._table[i];if(e){if(e.expires>Date.now())return e.value;this.remove(i)}return null}set(i,e,t=6e4){this._table[i]={key:i,value:e,expires:t>0?Date.now()+t:0}}remove(i){delete this._table[i]}clear(){this._table={}}load(i){this._table=JSON.parse(i)}},h=new x,j={default:h};var g="https://leetcode.com",f="https://leetcode.cn",d="Mozilla/5.0 LeetCode API";import Q from"node-fetch";function p(u){return u.split(";").map(i=>i.trim().split("=")).reduce((i,e)=>(i[e[0]]=e[1],i),{})}async function A(){let u=await Q(g,{headers:{"user-agent":d}}).then(e=>e.headers.get("set-cookie"));return p(u).csrftoken}var y=class{constructor(i){i&&(this.session=i.session,this.csrf=i.csrf)}async init(i){return this.csrf=await A(),i&&(this.session=i),this}};var R=`
query ($username: String!) {
    userContestRanking(username: $username) {
        attendedContestsCount
        rating
        globalRanking
        totalParticipants
        topPercentage
        badge {
            name
        }
    }
    userContestRankingHistory(username: $username) {
        attended
        trendDirection
        problemsSolved
        totalProblems
        finishTimeInSeconds
        rating
        ranking
        contest {
            title
            startTime
        }
    }
}
`;var _=`
query {
    activeDailyCodingChallengeQuestion {
        date
        link
        question {
            questionId
            questionFrontendId
            boundTopicId
            title
            titleSlug
            content
            translatedTitle
            translatedContent
            isPaidOnly
            difficulty
            likes
            dislikes
            isLiked
            similarQuestions
            exampleTestcases
            contributors {
                username
                profileUrl
                avatarUrl
            }
            topicTags {
                name
                slug
                translatedName
            }
            companyTagStats
            codeSnippets {
                lang
                langSlug
                code
            }
            stats
            hints
            solution {
                id
                canSeeDetail
                paidOnly
                hasVideoSolution
                paidOnlyVideo
            }
            status
            sampleTestCase
            metaData
            judgerAvailable
            judgeType
            mysqlSchemas
            enableRunCode
            enableTestMode
            enableDebugger
            envInfo
            libraryUrl
            adminUrl
            challengeQuestion {
                id
                date
                incompleteChallengeCount
                streakCount
                type
            }
            note
        }
    }
}
`;var q=`
query ($titleSlug: String!) {
    question(titleSlug: $titleSlug) {
        questionId
        questionFrontendId
        boundTopicId
        title
        titleSlug
        content
        translatedTitle
        translatedContent
        isPaidOnly
        difficulty
        likes
        dislikes
        isLiked
        similarQuestions
        exampleTestcases
        contributors {
            username
            profileUrl
            avatarUrl
        }
        topicTags {
            name
            slug
            translatedName
        }
        companyTagStats
        codeSnippets {
            lang
            langSlug
            code
        }
        stats
        hints
        solution {
            id
            canSeeDetail
            paidOnly
            hasVideoSolution
            paidOnlyVideo
        }
        status
        sampleTestCase
        metaData
        judgerAvailable
        judgeType
        mysqlSchemas
        enableRunCode
        enableTestMode
        enableDebugger
        envInfo
        libraryUrl
        adminUrl
        challengeQuestion {
            id
            date
            incompleteChallengeCount
            streakCount
            type
        }
        note
    }
}
`;var L=`
query ($categorySlug: String, $limit: Int, $skip: Int, $filters: QuestionListFilterInput) {
    problemsetQuestionList: questionList( 
        categorySlug: $categorySlug
        limit: $limit
        skip: $skip
        filters: $filters
    ) {
        total: totalNum
        questions: data {
            acRate 
            difficulty 
            freqBar 
            questionFrontendId 
            isFavor
            isPaidOnly 
            status 
            title 
            titleSlug 
            topicTags { name id slug } 
            hasSolution 
            hasVideoSolution
        }
    }
}
`;var U=`
query ($username: String!) {
    allQuestionsCount {
        difficulty
        count
    }
    matchedUser(username: $username) {
        username
        socialAccounts
        githubUrl
        contributions {
            points
            questionCount
            testcaseCount
        }
        profile {
            realName
            websites
            countryName
            skillTags
            company
            school
            starRating
            aboutMe
            userAvatar
            reputation
            ranking
        }
        submissionCalendar
        submitStats {
            acSubmissionNum {
                difficulty
                count
                submissions
            }
            totalSubmissionNum {
                difficulty
                count
                submissions
            }
        }
        badges {
            id
            displayName
            icon
            creationDate
        }
        upcomingBadges {
            name
            icon
        }
        activeBadge {
            id
        }
    }
    recentSubmissionList(username: $username, limit: 20) {
        title
        titleSlug
        timestamp
        statusDisplay
        lang
    }
}
`;var I=`
query ($username: String!, $limit: Int) {
    recentSubmissionList(username: $username, limit: $limit) {
        title
        titleSlug
        timestamp
        statusDisplay
        lang
    }
}
`;var T=`
query ($offset: Int!, $limit: Int!, $slug: String) {
    submissionList(offset: $offset, limit: $limit, questionSlug: $slug) {
        hasNext
        submissions { id lang time timestamp statusDisplay runtime url isPending title memory titleSlug }
    }
}
`;var N=`
query {
    userStatus {
      userId
      username
      avatar
      isSignedIn
      isMockUser
      isPremium
      isAdmin
      isSuperuser
      isTranslator
      permissions
    }
  }
  `;import $ from"events";var k=class extends ${constructor(e=1){super();this.space=e,this.used=0,this.releases=[]}async lock(){if(this.used>=this.space){let e=new Promise(t=>this.releases.push(t));this.emit("wait",{lock:e,release:this.releases[this.releases.length-1]}),await e}return this.used++,this.emit("lock"),this.used}unlock(){var e;return this.used<=0?0:(this.releases.length>0&&((e=this.releases.shift())==null||e()),this.used--,this.emit("unlock"),this.used<=0&&this.emit("all-clear"),this.used)}resize(e){var t;for(this.space=e;this.used<e&&this.releases.length>0;)(t=this.releases.shift())==null||t();return this.space}full(){return this.used>=this.space}waiting(){return this.releases.length}},b=class extends k{constructor({limit:e=20,interval:t=1e4,concurrent:s=2}={}){super(s);this.count=0;this.last=0;this.time_mutex=new k(e),this.interval=t,this.time_mutex.on("lock",(...n)=>this.emit("time-lock",...n)),this.time_mutex.on("unlock",(...n)=>this.emit("time-unlock",...n))}async lock(){return this.last+this.interval<Date.now()?this.reset():this.time_mutex.full()&&!this.timer&&this.cleaner(),await this.time_mutex.lock(),this.count++,super.lock()}reset(){for(;this.count>0;)this.time_mutex.unlock(),this.count--;this.last=Date.now(),this.emit("timer-reset")}cleaner(){this.timer=setTimeout(()=>{this.reset(),setTimeout(()=>{this.time_mutex.waiting()>0?this.cleaner():this.timer=void 0},0)},this.last+this.interval-Date.now())}set limit(e){this.time_mutex.resize(e)}};var w=class extends O{constructor(e=null,t=h){super();this.limiter=new b;let s;this.initialized=new Promise(n=>{s=n}),this.cache=t,e?(this.credential=e,setImmediate(()=>s())):(this.credential=new y,this.credential.init().then(()=>s()))}async user(e){await this.initialized;let{data:t}=await this.graphql({variables:{username:e},query:U});return t}async user_contest_info(e){await this.initialized;let{data:t}=await this.graphql({variables:{username:e},query:R});return t}async recent_submissions(e,t=20){await this.initialized;let{data:s}=await this.graphql({variables:{username:e,limit:t},query:I});return s.recentSubmissionList||[]}async submissions({limit:e=20,offset:t=0,slug:s}={}){await this.initialized;let n=[],m=new Set,l=t;for(;n.length<e;){let{data:c}=await this.graphql({variables:{offset:l,limit:e-n.length>20?20:e-n.length,slug:s},query:T});for(let r of c.submissionList.submissions)r.id=parseInt(r.id,10),r.timestamp=parseInt(r.timestamp,10)*1e3,r.isPending=r.isPending!=="Not Pending",r.runtime=parseInt(r.runtime,10)||0,r.memory=parseFloat(r.memory)||0,!m.has(r.id)&&(m.add(r.id),n.push(r));if(!c.submissionList.hasNext)break;l+=20}return n}async submission(e){var t;await this.initialized;try{await this.limiter.lock();let m=(t=(await(await E(`${g}/submissions/detail/${e}/`,{headers:{origin:g,referer:g,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"user-agent":d}})).text()).match(/var pageData = ({[^]+?});/))==null?void 0:t[1],l=new Function("return "+m)(),c={id:parseInt(l.submissionId),problem_id:parseInt(l.questionId),runtime:parseInt(l.runtime),runtime_distribution:l.runtimeDistributionFormatted?JSON.parse(l.runtimeDistributionFormatted).distribution.map(r=>[+r[0],r[1]]):[],runtime_percentile:0,memory:parseInt(l.memory),memory_distribution:l.memoryDistributionFormatted?JSON.parse(l.memoryDistributionFormatted).distribution.map(r=>[+r[0],r[1]]):[],memory_percentile:0,code:l.submissionCode,details:l.submissionData};return c.runtime_percentile=c.runtime_distribution.reduce((r,[v,C])=>r+(v>=c.runtime?C:0),0),c.memory_percentile=c.memory_distribution.reduce((r,[v,C])=>r+(v>=c.memory/1e3?C:0),0),this.limiter.unlock(),c}catch(s){throw this.limiter.unlock(),s}}async problems({category:e="",offset:t=0,limit:s=100,filters:n={}}={}){await this.initialized;let m={categorySlug:e,skip:t,limit:s,filters:n},{data:l}=await this.graphql({variables:m,query:L});return l.problemsetQuestionList}async problem(e){await this.initialized;let{data:t}=await this.graphql({variables:{titleSlug:e.toLowerCase().replace(/\s/g,"-")},query:q});return t.question}async daily(){await this.initialized;let{data:e}=await this.graphql({query:_});return e.activeDailyCodingChallengeQuestion}async whoami(){await this.initialized;let{data:e}=await this.graphql({operationName:"globalData",variables:{},query:N});return e.userStatus}async graphql(e){await this.initialized;try{await this.limiter.lock();let t=g,s=await E(`${t}/graphql`,{method:"POST",headers:{"content-type":"application/json",origin:t,referer:t,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"x-csrftoken":this.credential.csrf||"","user-agent":d},body:JSON.stringify(e)});if(this.emit("receive-graphql",s.clone()),s.headers.has("set-cookie")){let n=p(s.headers.get("set-cookie"));n.csrftoken&&(this.credential.csrf=n.csrftoken,this.emit("update-csrf",this.credential))}return this.limiter.unlock(),s.json()}catch(t){throw this.limiter.unlock(),t}}},D=w;import B from"events";import z from"node-fetch";import M from"node-fetch";async function F(){let i=(await M(`${f}/graphql/`,{method:"POST",headers:{"content-type":"application/json","user-agent":d},body:JSON.stringify({operationName:"nojGlobalData",variables:{},query:`query nojGlobalData {
  siteRegion
  chinaHost
  websocketUrl
}
`})})).headers.get("set-cookie");return p(i).csrftoken}var S=class{constructor(i){i&&(this.session=i.session,this.csrf=i.csrf)}async init(i){return this.csrf=await F(),i&&(this.session=i),this}};var P=class extends B{constructor(e=null,t=h){super();this.limiter=new b;let s;this.initialized=new Promise(n=>{s=n}),this.cache=t,e?(this.credential=e,setImmediate(()=>s())):(this.credential=new S,this.credential.init().then(()=>s()))}async user(e){await this.initialized;let{data:t}=await this.graphql({operationName:"getUserProfile",variables:{username:e},query:`
            query getUserProfile($username: String!) {
                userProfileUserQuestionProgress(userSlug: $username) {
                    numAcceptedQuestions { difficulty count }
                    numFailedQuestions { difficulty count }
                    numUntouchedQuestions { difficulty count }
                }
                userProfilePublicProfile(userSlug: $username) {
                    username haveFollowed siteRanking
                    profile { 
                        userSlug realName aboutMe userAvatar location gender websites skillTags contestCount asciiCode
                        medals { name year month category }
                        ranking { 
                            currentLocalRanking currentGlobalRanking currentRating totalLocalUsers totalGlobalUsers
                        }
                        socialAccounts { provider profileUrl }
                    }
                }
            }
            `});return t}async graphql(e,t="/graphql/"){await this.initialized;try{await this.limiter.lock();let s=f,n=await z(`${s}${t}`,{method:"POST",headers:{"content-type":"application/json",origin:s,referer:s,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"x-csrftoken":this.credential.csrf||"","user-agent":d},body:JSON.stringify(e)});if(this.emit("receive-graphql",n.clone()),n.headers.has("set-cookie")){let m=p(n.headers.get("set-cookie"));m.csrftoken&&(this.credential.csrf=m.csrftoken,this.emit("update-csrf",this.credential))}return this.limiter.unlock(),n.json()}catch(s){throw this.limiter.unlock(),s}}},G=P;var ze=D;export{g as BASE_URL,f as BASE_URL_CN,x as Cache,y as Credential,D as LeetCode,G as LeetCodeCN,k as Mutex,b as RateLimiter,d as USER_AGENT,h as cache,j as caches,ze as default};
